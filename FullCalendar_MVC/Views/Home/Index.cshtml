@{
    ViewBag.Title = "Home Page";
}

@section scripts{

    <script>
        $(document).ready(function() {

            var sourceFullView = { url: '/Home/GetDiaryEvents/' };
            var sourceSummaryView = { url: '/Home/GetDiarySummary/' };
            var CalLoading = true;

            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                defaultView: 'agendaDay',
                editable: true,
                allDaySlot: false,
                selectable: true,
                slotMinutes: 15,

                //events: function (start, end, timezone, callback) {
                //    $.ajax({
                //        url: 'Home/Eventos/',
                //        data: {
                //            // our hypothetical feed requires UNIX timestamps
                //            start: start.unix(),
                //            end: end.unix()
                //        },
                //        success: function (doc) {
                //            var events = [];
                //            $(doc).find('event').each(function () {
                //                events.push({
                //                    title: $(this).attr('title'),
                //                    start: $(this).attr('start') // will be parsed
                //                });
                //            });
                //            callback(events);
                //        }
                //    });
                //},

                utc: true,
                events: {
                   
                    url: "Home/Eventos/",
                    data:{
                    timezone: 'America/Cuiaba'
                    
                }
                    
                    //succes: function(response).
                },
                //events: function(start, end, timezone) {
                //   // var convert = moment(start).tz("America/Cuiaba").format("YYYY-MM-DD HH:mm");
                //    $.ajax({
                //        url: "/Home/Eventos",
                //        dataType: "json",
                //        data: {
                //            start: start.unix(),
                //            end: end.unix()
                //        },
                //        success: function(response) {
                //            var events = [];
                //            $(response).find('events').each(function () {
                //                var start = moment(response.start).tz("America/Cuiaba").format("HH:mm");
                //                console.log(start);
                //                var end = moment(response.start).tz("America/Cuiaba").format("HH:mm");
                //                console.log(end);
                //                events.push({
                //                    title: $(this).attr('title'),
                //                    start: start,
                //                    end: end // will be parsed
                //                });
                //            });
                //            callback(events);
                //        }
                //    });

                //},


                eventClick: function(calEvent, jsEvent, view) {
                    alert('You clicked on event id: ' +
                        calEvent.id +
                        "\nSpecial ID: " + ID,
                        calEvent.someKey +
                        "\nAnd the title is: " +
                        calEvent.title);

                },

                eventDrop: function(event, dayDelta, minuteDelta, allDay, revertFunc) {
                    if (confirm("Confirm move?")) {
                        UpdateEvent(event.id, event.start);

                    } else {
                        revertFunc();
                    }
                },

                eventResize: function(event, dayDelta, minuteDelta, revertFunc) {

                    if (confirm("Confirm change appointment length?")) {
                        UpdateEvent(event.id, event.start, event.end);
                    } else {
                        revertFunc();
                    }
                },


                dayClick: function(date, allDay, jsEvent, view) {
                    $('#eventTitle').val("");
                    $('#eventDate').val($.fullCalendar.formatDate(date, 'dd/MM/yyyy'));
                    $('#eventTime').val($.fullCalendar.formatDate(date, 'HH:mm'));
                    ShowEventPopup(date);
                },

                viewRender: function(view, element) {

                    if (!CalLoading) {
                        if (view.name == 'month') {
                            $('#calendar').fullCalendar('removeEventSource', sourceFullView);
                            $('#calendar').fullCalendar('removeEvents');
                            $('#calendar').fullCalendar('addEventSource', sourceSummaryView);
                        } else {
                            $('#calendar').fullCalendar('removeEventSource', sourceSummaryView);
                            $('#calendar').fullCalendar('removeEvents');
                            $('#calendar').fullCalendar('addEventSource', sourceFullView);
                        }
                    }
                }
            });

            CalLoading = false;


        });

        $('#btnInit').click(function() {
            $.ajax({
                type: 'POST',
                url: "/Home/Init",
                success: function(response) {
                    if (response == 'True') {
                        $('#calendar').fullCalendar('refetchEvents');
                        alert('Database populated! ');
                    } else {
                        alert('Error, could not populate database!');
                    }
                }
            });
        });

        $('#btnPopupCancel').click(function() {
            ClearPopupFormValues();
            $('#popupEventForm').hide();
        });

        $('#btnPopupSave').click(function() {

            $('#popupEventForm').hide();

            var dataRow = {
                'titulo': $('#eventTitle').val(),
                'novaDataEvento': $('#eventDate').val(),
                'novaHoraEvento': $('#eventTime').val(),
                'novoDuracaoEvento': $('#eventDuration').val()
            }

            ClearPopupFormValues();

            $.ajax({
                type: 'POST',
                url: "/Home/SaveEvent",
                data: dataRow,
                success: function(response) {
                    if (response === 'True') {
                        $('#calendar').fullCalendar('refetchEvents');
                        alert('New event saved!');
                    } else {
                        alert('Error, could not save event!');
                    }
                }
            });
        });

        function ShowEventPopup(date) {
            ClearPopupFormValues();
            $('#popupEventForm').show();
            $('#eventTitle').focus();
        }

        function ClearPopupFormValues() {
            $('#eventID').val("");
            $('#eventTitle').val("");
            $('#eventDateTime').val("");
            $('#eventDuration').val("");
        }

        function UpdateEvent(EventID, EventStart, EventEnd) {

            var dataRow = {
                'ID': EventID,
                'NewEventStart': EventStart,
                'NewEventEnd': EventEnd
            }

            $.ajax({
                type: 'POST',
                url: "/Home/UpdateEvent",
                dataType: "json",
                contentType: "application/json",
                data: JSON.stringify(dataRow)
            });
        }

    </script>


}


<div class="container">

    <div>
        <a href="#" id="btnInit" class="btn btn-secondary">Initialise database!</a>
    </div>

    <div id='calendar' style="width:65%"></div>

</div>


<div id="popupEventForm" class="modal hide" style="display: none;">
    <div class="modal-header"><h3>Add new event</h3></div>
    <div class="modal-body">
        <form id="EventForm" class="well">
            <input type="hidden" id="eventID">
            <label>Cliente</label>
            <input type="text" id="eventTitle" placeholder="Title here"><br />
            <label>Data</label>
            <input type="text" id="eventDate"><br />
            <label>Hora do Evento</label>
            <input type="text" id="eventTime"><br />
            <label>Duração do Evento (Minutos)</label>
            <input type="text" id="eventDuration" placeholder="15"><br />
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" id="btnPopupCancel" data-dismiss="modal" class="btn">Cancelar</button>
        <button type="button" id="btnPopupSave" data-dismiss="modal" class="btn btn-primary">Salvar Evento</button>
    </div>
</div>










